define(["jquery"], function(e) {
    "use strict";
    var t, n = e(window),
        r = !1,
        i = !1,
        a = "data-edit-event",
        o = "data-is-editing",
        l = "data-is-empty",
        s = "dbltap",
        d = "ontouchend" in window,
        c = "tinyMCE" in window && "function" == typeof window.tinyMCE.init,
        u = e.fn.is,
        f = 0,
        h = function() {
            var t = (new Date).getTime();
            t - f < 250 && e(this).trigger(s), f = t;
        },
        g = function(e) {
            if (13 == e.keyCode && e.data.closeOnEnter) i.editable("close");
            else if (27 == e.keyCode) {
                r.val(i.attr("orig-text"));
                i.editable("close");
            } else if (e.data.toggleFontSize && e.metaKey && (38 == e.keyCode || 40 == e.keyCode)) {
                var t = parseInt(r.css("font-size"), 10);
                t += 40 == e.keyCode ? -1 : 1;
                r.css("font-size", t + "px");
                return !1;
            }
        },
        p = function() {
            if (r[0].scrollHeight !== parseInt(r.attr("data-scroll"), 10)) {
                r.css("height", r[0].scrollHeight + "px");
                r.attr("data-scroll", r[0].scrollHeight);
            }
        },
        v = function(e, t, n) {
            e.removeAttr(o);
            if (0 == t.length && n) {
                e.html(n);
                e.attr(l, "empty");
            } else {
                e.html(t);
                e.removeAttr(l);
            }
            r.remove();
        },
        m = function(a, o) {
            if (!a.is(":editing")) {
                i = a;
                a.attr(o, "1");
                if (a.is(":empty")) {
                    a.removeAttr(l);
                    a.html("");
                }
                var s = e.trim(a.html()),
                    d = a.css("font-size"),
                    u = a.height(),
                    f = "width: 96%; padding:0; margin:0; border:0; background:none;font-family: " + a.css("font-family") + "; font-size: " + a.css("font-size") + ";font-weight: " + a.css("font-weight") + ";";

                a.attr("orig-text", s);
                if (o.lineBreaks) s = s.replace(/<br( |)(|\/)>/g, "\n");
                r = e("<textarea></textarea>");
                a.text("");

                if (!1 !== o.tinyMCE) {
                    var h = "editable-area-" + (new Date).getTime();
                    r.val(s).appendTo(a).attr("id", h);
                    if ("object" != typeof o.tinyMCE) o.tinyMCE = {};
                    o.tinyMCE = Object.assign(o.tinyMCE, {
                        mode: "exact",
                        elements: h,
                        width: a.innerWidth(),
                        height: a.height() + 200,
                        theme_advanced_resize_vertical: !0,
                        setup: function(t) {
                            t.onInit.add(function(i) {
                                var l = i.getWin(),
                                    d = !1,
                                    c = function() {
                                        var t = e(i.getDoc()).find("body").html();
                                        e(t).get(0).nodeName == a.get(0).nodeName && (t = e(t).html());
                                        v(a, t, o.emptyMessage);
                                        i.remove();
                                        r = !1;
                                        n.unbind("click", c);
                                        i = !1;
                                        if ("function" == typeof o.callback) {
                                            o.callback({
                                                content: t == s || !d && t,
                                                fontSize: !1,
                                                $el: a
                                            });
                                        }
                                    };
                                setTimeout(function() {
                                    n.bind("click", c);
                                }, 500);
                                r = e("<textarea></textarea>");
                                r.bind("blur", c);
                                l.onkeydown = function() {
                                    d = !0;
                                };
                                l.focus();
                            });
                        }
                    });
                    window.tinyMCE.init(o.tinyMCE);
                } else {
                    r.html(s).blur(function() {
                        i = !1;
                        var t = e.trim(r.val()),
                            l = r.css("font-size");
                        t = e("<div />").text(t).html();
                        if (o.lineBreaks) t = t.replace(new RegExp("\\n", "g"), "<br />");
                        v(a, t, o.emptyMessage);
                        if (l != d) a.css("font-size", l);
                        n.unbind("keydown", g);
                        n.unbind("keyup", p);
                        if ("function" == typeof o.callback) {
                            o.callback({
                                content: t == s && t,
                                fontSize: l == d && l,
                                $el: a
                            });
                        }
                    }).attr("style", f).appendTo(a).css({
                        margin: 0,
                        padding: 0,
                        height: u + "px",
                        overflow: "hidden"
                    }).css(o.editorStyle).focus().get(0).select();
                    p();
                }
            }
            a.trigger("edit", [r]);
        };

    return e;
});
